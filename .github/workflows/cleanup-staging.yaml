name: Cleanup Staging Environments

on:
  delete:  # Triggered when a branch is deleted
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name or branch name to remove (will be sanitized)'
        required: false
        type: string

jobs:
  cleanup-deleted-branch:
    name: Cleanup Deleted Branch
    if: github.event_name == 'delete' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fleet-infra repo
        uses: actions/checkout@v6
        with:
          repository: NickMous/fleet-infra
          token: ${{ secrets.FLEET_REPO_TOKEN }}

      - name: Generate branch slug
        id: branch
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          BRANCH_SLUG=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | cut -c1-30 | sed 's/-$//')
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "slug=$BRANCH_SLUG" >> $GITHUB_OUTPUT
          echo "Branch deleted: $BRANCH_NAME -> Slug: $BRANCH_SLUG"

      - name: Remove staging branch config
        run: |
          BRANCH_SLUG="${{ steps.branch.outputs.slug }}"

          if [ -d "apps/beanstash/staging-branches/${BRANCH_SLUG}" ]; then
            rm -rf "apps/beanstash/staging-branches/${BRANCH_SLUG}"
            echo "Removed staging config for branch: ${BRANCH_SLUG}"
          else
            echo "No staging config found for branch: ${BRANCH_SLUG}"
          fi

      - name: Update root staging kustomization
        run: |
          # Rebuild the root kustomization.yaml with all branch directories
          cd apps/beanstash/staging-branches

          # Start with header
          echo "# Root kustomization for staging branches" > kustomization.yaml
          echo "# This file is auto-generated by GitHub Actions" >> kustomization.yaml
          echo "apiVersion: kustomize.config.k8s.io/v1beta1" >> kustomization.yaml
          echo "kind: Kustomization" >> kustomization.yaml
          echo "" >> kustomization.yaml
          echo "resources:" >> kustomization.yaml

          # Add all branch directories (excluding generator, files starting with .)
          for dir in */; do
            if [ "$dir" != "generator/" ] && [ -f "${dir}kustomization.yaml" ]; then
              echo "  - ${dir}" >> kustomization.yaml
            fi
          done

          # If no branches, add empty resources
          if ! grep -q "^  - " kustomization.yaml; then
            echo "  []" >> kustomization.yaml
          fi

          echo "Updated root kustomization:"
          cat kustomization.yaml

      - name: Commit and push cleanup
        run: |
          BRANCH_SLUG="${{ steps.branch.outputs.slug }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A apps/beanstash/staging-branches/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(flux): cleanup staging ${BRANCH_SLUG}" \
              -m "Branch deleted: ${{ steps.branch.outputs.name }}"

            git push
            echo "Pushed cleanup for branch: ${BRANCH_SLUG}"
          fi

      - name: Trigger Flux reconciliation
        if: vars.FLUX_WEBHOOK_ENABLED == 'true'
        env:
          FLUX_WEBHOOK_URL: ${{ secrets.FLUX_WEBHOOK_URL }}
        run: |
          curl -X POST "$FLUX_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{"action": "cleanup", "branch": "${{ steps.branch.outputs.slug }}"}' \
            --fail --silent --show-error || echo "Webhook notification failed (non-fatal)"
        continue-on-error: true

      - name: Output cleanup summary
        run: |
          echo "### ðŸ—‘ï¸ Staging Environment Cleanup Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.branch.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Branch deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Flux will automatically remove the resources within a few minutes." >> $GITHUB_STEP_SUMMARY

  manual-cleanup:
    name: Manual Cleanup
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment_name != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fleet-infra repo
        uses: actions/checkout@v6
        with:
          repository: NickMous/fleet-infra
          token: ${{ secrets.FLEET_REPO_TOKEN }}

      - name: Generate environment slug
        id: env
        run: |
          ENV_NAME="${{ github.event.inputs.environment_name }}"
          ENV_SLUG=$(echo "$ENV_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | cut -c1-30 | sed 's/-$//')
          echo "name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "slug=$ENV_SLUG" >> $GITHUB_OUTPUT
          echo "Environment: $ENV_NAME -> Slug: $ENV_SLUG"

      - name: Remove staging environment config
        run: |
          ENV_SLUG="${{ steps.env.outputs.slug }}"

          if [ -d "apps/beanstash/staging-branches/${ENV_SLUG}" ]; then
            rm -rf "apps/beanstash/staging-branches/${ENV_SLUG}"
            echo "Removed staging config for environment: ${ENV_SLUG}"
          else
            echo "No staging config found for environment: ${ENV_SLUG}"
            exit 1
          fi

      - name: Update root staging kustomization
        run: |
          # Rebuild the root kustomization.yaml with all branch directories
          cd apps/beanstash/staging-branches

          # Start with header
          echo "# Root kustomization for staging branches" > kustomization.yaml
          echo "# This file is auto-generated by GitHub Actions" >> kustomization.yaml
          echo "apiVersion: kustomize.config.k8s.io/v1beta1" >> kustomization.yaml
          echo "kind: Kustomization" >> kustomization.yaml
          echo "" >> kustomization.yaml
          echo "resources:" >> kustomization.yaml

          # Add all branch directories (excluding generator, files starting with .)
          for dir in */; do
            if [ "$dir" != "generator/" ] && [ -f "${dir}kustomization.yaml" ]; then
              echo "  - ${dir}" >> kustomization.yaml
            fi
          done

          # If no branches, add empty resources
          if ! grep -q "^  - " kustomization.yaml; then
            echo "  []" >> kustomization.yaml
          fi

          echo "Updated root kustomization:"
          cat kustomization.yaml

      - name: Commit and push cleanup
        run: |
          ENV_SLUG="${{ steps.env.outputs.slug }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A apps/beanstash/staging-branches/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(flux): cleanup staging ${ENV_SLUG}" \
              -m "Manual cleanup requested"

            git push
            echo "Pushed cleanup for environment: ${ENV_SLUG}"
          fi

      - name: Trigger Flux reconciliation
        if: vars.FLUX_WEBHOOK_ENABLED == 'true'
        env:
          FLUX_WEBHOOK_URL: ${{ secrets.FLUX_WEBHOOK_URL }}
        run: |
          curl -X POST "$FLUX_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{"action": "cleanup", "environment": "${{ steps.env.outputs.slug }}"}' \
            --fail --silent --show-error || echo "Webhook notification failed (non-fatal)"
        continue-on-error: true

      - name: Output cleanup summary
        run: |
          echo "### ðŸ—‘ï¸ Staging Environment Cleanup Triggered (Manual)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ steps.env.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Slug:** \`${{ steps.env.outputs.slug }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Manual cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Flux will automatically remove the resources within a few minutes." >> $GITHUB_STEP_SUMMARY
